# Audit K-Docs - 28 janvier 2026

## Vue d'ensemble

K-Docs est un système de gestion documentaire (GED) avec OCR, classification IA et workflows d'approbation.

## Architecture technique

### Stack
- **Backend**: PHP 8.4 + Slim Framework 4
- **Base de données**: MariaDB (port 3307)
- **Frontend**: Tailwind CSS + JavaScript vanilla
- **OCR**: Tesseract OCR
- **IA**: Claude API (Anthropic)
- **PDF**: Ghostscript, Poppler (pdftotext, pdftoppm), ImageMagick

### Structure des dossiers
```
kdocs/
├── app/
│   ├── Controllers/      # Contrôleurs MVC + API
│   ├── Core/             # Database, Config, Session
│   ├── Helpers/          # FolderTreeHelper
│   ├── Middleware/       # Auth, AutoIndex
│   ├── Models/           # Document, User, Role, Setting, etc.
│   ├── Services/         # Services métier (OCR, Claude, Workflow, etc.)
│   ├── Search/           # SearchQuery, SearchResult, SearchQueryBuilder
│   ├── Workflow/         # Nodes (Triggers, Conditions, Actions)
│   └── workers/          # queue_worker.php, indexing_worker.php
├── config/               # config.php
├── database/             # migrations/
├── public/               # css/, js/
├── storage/              # documents/, consume/, processed/, temp/
├── templates/            # Vues PHP (layouts, partials, pages)
└── vendor/               # Dépendances Composer
```

## Fonctionnalités implémentées

### 1. Gestion documentaire
- [x] Upload de documents (PDF, images, Word)
- [x] Arborescence de dossiers avec navigation
- [x] Visualisation de documents avec visionneuse PDF
- [x] Métadonnées : titre, correspondant, type, tags, date
- [x] Recherche full-text dans contenu et OCR
- [x] Corbeille (soft delete)

### 2. OCR et extraction
- [x] OCR automatique via Tesseract
- [x] Extraction de texte PDF natif (pdftotext)
- [x] Génération de miniatures (pdftoppm + ImageMagick)
- [x] Détection de langue

### 3. Classification IA (Claude)
- [x] Classification automatique des documents
- [x] Extraction de métadonnées (date, montant, correspondant)
- [x] Suggestions de tags
- [x] Split de documents multi-pages

### 4. Consume Folder
- [x] Surveillance du dossier `storage/consume/`
- [x] Traitement automatique des nouveaux fichiers
- [x] Interface de validation dans `/admin/consume`
- [x] Statuts : pending → validated/indexed

### 5. Recherche avancée (Chat IA)
- [x] Questions en langage naturel
- [x] Conversion en requêtes SQL via Claude
- [x] Réponses analytiques ("combien de fois le mot X apparaît")
- [x] Score de pertinence et extraits avec highlighting
- [x] **Historique des conversations** (nouveau)
  - Sidebar des conversations récentes
  - Persistance en base de données
  - Reprise de conversations

### 6. Workflows
- [x] Designer visuel de workflows (drag & drop)
- [x] Triggers : document_created, tag_added, scheduled, etc.
- [x] Conditions : if_correspondent, if_tag, if_document_type
- [x] Actions : assign_tag, move_to_folder, send_email, set_validation_status
- [x] Exécution asynchrone via queue

### 7. Validation de documents
- [x] Statuts de validation par utilisateur
- [x] Workflow d'approbation multi-niveaux
- [x] Notifications par email
- [x] Interface "Mes tâches"

### 8. Utilisateurs et rôles
- [x] Authentification session
- [x] Rôles : admin, user, validator, approver
- [x] Gestion des utilisateurs

### 9. Administration
- [x] Paramètres système (storage, OCR, IA)
- [x] Gestion des correspondants
- [x] Gestion des types de documents
- [x] Gestion des tags
- [x] Statistiques d'utilisation API Claude

## Base de données

### Tables principales
| Table | Description |
|-------|-------------|
| users | Utilisateurs |
| documents | Documents avec métadonnées |
| document_folders | Arborescence des dossiers |
| correspondents | Correspondants/expéditeurs |
| document_types | Types de documents |
| tags | Tags |
| document_tags | Liaison documents-tags |
| workflow_definitions | Définitions de workflows |
| workflow_executions | Exécutions de workflows |
| workflow_tasks | Tâches de workflow |
| document_validations | Validations par utilisateur |
| chat_conversations | Conversations de chat IA |
| chat_messages | Messages des conversations |
| settings | Paramètres système |
| api_usage_logs | Logs d'utilisation API Claude |

## Points d'attention

### Performance
- Indexation par lots avec pauses configurables
- Cache des requêtes de navigation dossiers
- Lazy loading des sous-dossiers

### Sécurité
- Échappement HTML systématique
- Paramètres préparés pour SQL
- Validation des uploads (extensions, MIME types)
- Authentification requise pour toutes les routes (sauf login)

### Configuration requise
- PHP 8.4+ avec extensions : pdo_mysql, curl, fileinfo, mbstring
- Tesseract OCR
- Ghostscript
- Poppler utils (pdftotext, pdftoppm)
- ImageMagick
- Clé API Claude (optionnelle, pour IA)

## Statistiques actuelles

```
Documents : 13
  - indexed : 2
  - pending : 10
  - validated : 1

Types de documents utilisés : Contrat, Autre

Dossiers : ~10

Utilisateurs : 1 (admin)
```

## Dernières modifications (28/01/2026)

1. **Fix recherche** : Correction du problème PDO avec paramètres nommés dupliqués
2. **Amélioration résultats** : Score de pertinence + extraits avec highlighting
3. **Réponses analytiques** : "Combien de fois le mot X apparaît" → compte et répartition
4. **Historique chat** :
   - Tables `chat_conversations` et `chat_messages`
   - Sidebar des conversations
   - Persistance et reprise des conversations
5. **Fix config** : Fusion des clés `storage` dupliquées

## Prochaines améliorations potentielles

- [ ] Export de documents (ZIP, PDF fusionné)
- [ ] OCR par lots en arrière-plan
- [ ] Intégration kDrive (stockage cloud)
- [ ] API REST complète documentée
- [ ] Recherche avec opérateurs (AND, OR, NOT)
- [ ] Historique des modifications (audit trail)
- [ ] Multi-tenant (plusieurs organisations)
